# Check https://circleci.com/docs/2.0/ for more details
version: 2
jobs:
  build:
    machine:
      image: circleci/classic:201808-01
    environment:
      K3S_VERSION: 0.9.1

    working_directory: ~/k3s-circleci
    steps:
      - checkout
      - run:
          name: Setup k3s
          command: |
            curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 664" INSTALL_K3S_VERSION=v${K3S_VERSION} sh -
            sleep 5

      - run:
          name: Get k3s nodes
          command: |
            kubectl get node

      - run:
          name: Create a nginx deployment
          command: | 
            kubectl create deployment nginx --image=nginx

      - run:
          name: Create a ClusterIP service
          command: |
            kubectl create service clusterip nginx --tcp=80:80

      - run:
          name: Create an ingress object
          command: |
            cat <<EOF | kubectl apply -f -
            apiVersion: extensions/v1beta1
            kind: Ingress
            metadata:
               name: nginx
               annotations:
                 ingress.kubernetes.io/ssl-redirect: "false"
            spec:
              rules:
              - http:
                  paths:
                  - path: /
                    backend:
                      serviceName: nginx
                      servicePort: 80

      - run:
          name: cUrl test
          command: |
            curl -LI -s localhost:80/ -o /dev/null -w '%{http_code}\n'
